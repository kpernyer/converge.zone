---
phase: 06-testing-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - converge-platform/converge-core/tests/traits/mod.rs
  - converge-platform/converge-core/tests/traits/send_sync_static.rs
  - converge-platform/converge-core/tests/compile_fail/mod.rs
  - converge-platform/converge-core/tests/compile_fail/compile_fail.rs
  - converge-platform/converge-core/tests/compile_fail/ui/fact_new_private.rs
  - converge-platform/converge-core/tests/compile_fail/ui/validated_new_private.rs
  - converge-platform/converge-core/tests/compile_fail/ui/validation_report_private.rs
  - converge-platform/converge-core/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "static_assertions verify Send+Sync bounds for all capability boundary traits"
    - "static_assertions verify Send+Sync bounds for core types that cross thread boundaries"
    - "trybuild tests verify Fact::new() cannot be called from external code"
    - "trybuild tests verify Proposal<Validated>::from_validated() cannot be called externally"
    - "trybuild tests verify ValidationReport::new() cannot be called externally"
  artifacts:
    - path: "converge-platform/converge-core/tests/traits/send_sync_static.rs"
      provides: "Compile-time Send+Sync verification"
      contains: "assert_impl_all!"
    - path: "converge-platform/converge-core/tests/compile_fail/compile_fail.rs"
      provides: "trybuild test runner"
      contains: "trybuild::TestCases"
    - path: "converge-platform/converge-core/tests/compile_fail/ui/fact_new_private.rs"
      provides: "Test that Fact::new() is private"
      contains: "Fact::new"
    - path: "converge-platform/converge-core/tests/compile_fail/ui/validated_new_private.rs"
      provides: "Test that Proposal<Validated> constructor is private"
      contains: "from_validated"
  key_links:
    - from: "tests/traits/send_sync_static.rs"
      to: "converge_core::traits"
      via: "trait imports"
      pattern: "use converge_core::traits::"
    - from: "tests/compile_fail/compile_fail.rs"
      to: "tests/compile_fail/ui/*.rs"
      via: "trybuild glob"
      pattern: 'TestCases.*"ui/*.rs"'
---

<objective>
Create static assertions for Send+Sync bounds and compile-fail tests for private constructors. These are compile-time guarantees that document and enforce type safety invariants.

Purpose: Static assertions catch threading violations at compile time. Compile-fail tests ensure type-state constructors remain private, preventing bypass of the gate pattern.

Output: tests/traits/send_sync_static.rs with static assertions, tests/compile_fail/ with trybuild tests.
</objective>

<execution_context>
@/Users/kpernyer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kpernyer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-testing-infrastructure/06-RESEARCH.md
@.planning/phases/06-testing-infrastructure/06-01-SUMMARY.md

# Source files for trait definitions
@converge-platform/converge-core/src/traits/mod.rs
@converge-platform/converge-core/src/traits/llm.rs
@converge-platform/converge-core/src/traits/recall.rs
@converge-platform/converge-core/src/traits/store.rs
@converge-platform/converge-core/src/traits/validator.rs
@converge-platform/converge-core/src/types/fact.rs
@converge-platform/converge-core/src/types/proposal.rs
@converge-platform/converge-core/src/gates/validation.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create static assertions for Send+Sync bounds</name>
  <files>
    converge-platform/converge-core/tests/traits/mod.rs
    converge-platform/converge-core/tests/traits/send_sync_static.rs
  </files>
  <action>
**tests/traits/mod.rs**: Module declaration
```rust
mod send_sync_static;
```

**send_sync_static.rs**: Compile-time Send+Sync verification

Per 06-RESEARCH.md, these types MUST be Send+Sync:

```rust
//! Static assertions for Send+Sync bounds.
//!
//! These assertions verify at COMPILE TIME that types which cross
//! thread boundaries implement Send and Sync. Failures here indicate
//! a breaking change to thread safety guarantees.

use static_assertions::assert_impl_all;

// =============================================================================
// CORE TYPES
// =============================================================================

// Types that cross thread boundaries MUST be Send + Sync
use converge_core::types::{
    Fact, FactId, FactContent, FactContentKind,
    Proposal, Draft, Validated,
    ProposalId, ProposedContent, ProposedContentKind,
    Observation, ObservationId, ObservationKind,
    ContentHash, Timestamp,
    PromotionRecord, EvidenceRef, TraceLink, LocalTrace, RemoteRef,
    Actor, ActorKind, ValidationSummary,
    CorrectionEvent, CorrectionReason, CorrectionScope,
};

assert_impl_all!(Fact: Send, Sync);
assert_impl_all!(FactId: Send, Sync);
assert_impl_all!(FactContent: Send, Sync);
assert_impl_all!(FactContentKind: Send, Sync);

assert_impl_all!(Proposal<Draft>: Send, Sync);
assert_impl_all!(Proposal<Validated>: Send, Sync);
assert_impl_all!(ProposalId: Send, Sync);
assert_impl_all!(ProposedContent: Send, Sync);
assert_impl_all!(ProposedContentKind: Send, Sync);

assert_impl_all!(Observation: Send, Sync);
assert_impl_all!(ObservationId: Send, Sync);
assert_impl_all!(ObservationKind: Send, Sync);

assert_impl_all!(ContentHash: Send, Sync);
assert_impl_all!(Timestamp: Send, Sync);

assert_impl_all!(PromotionRecord: Send, Sync);
assert_impl_all!(EvidenceRef: Send, Sync);
assert_impl_all!(TraceLink: Send, Sync);
assert_impl_all!(LocalTrace: Send, Sync);
assert_impl_all!(RemoteRef: Send, Sync);
assert_impl_all!(Actor: Send, Sync);
assert_impl_all!(ActorKind: Send, Sync);
assert_impl_all!(ValidationSummary: Send, Sync);

assert_impl_all!(CorrectionEvent: Send, Sync);
assert_impl_all!(CorrectionReason: Send, Sync);
assert_impl_all!(CorrectionScope: Send, Sync);

// =============================================================================
// GATE TYPES
// =============================================================================

use converge_core::gates::{
    PromotionGate, ValidatedProposal, ValidationReport, ValidationPolicy,
    CheckResult, ValidationContext, ValidationError,
    CycleBudget, FactBudget, TokenBudget, ExecutionBudget,
    StopReason, ErrorCategory,
    AuthorityGrant, AuthorityScope,
};

assert_impl_all!(PromotionGate: Send, Sync);
assert_impl_all!(ValidatedProposal: Send, Sync);
assert_impl_all!(ValidationReport: Send, Sync);
assert_impl_all!(ValidationPolicy: Send, Sync);
assert_impl_all!(CheckResult: Send, Sync);
assert_impl_all!(ValidationContext: Send, Sync);
assert_impl_all!(ValidationError: Send, Sync);

assert_impl_all!(CycleBudget: Send, Sync);
assert_impl_all!(FactBudget: Send, Sync);
assert_impl_all!(TokenBudget: Send, Sync);
assert_impl_all!(ExecutionBudget: Send, Sync);
assert_impl_all!(StopReason: Send, Sync);
assert_impl_all!(ErrorCategory: Send, Sync);

assert_impl_all!(AuthorityGrant: Send, Sync);
assert_impl_all!(AuthorityScope: Send, Sync);

// =============================================================================
// KERNEL BOUNDARY TYPES
// =============================================================================

use converge_core::kernel_boundary::{
    TraceLink as KernelTraceLink, LocalTraceLink, RemoteTraceLink, Replayability,
    KernelProposal, KernelIntent, KernelContext, ContextFact, KernelPolicy,
    ContractResult, AdapterTrace, SamplerParams, RecallTrace, ExecutionEnv,
};

assert_impl_all!(KernelTraceLink: Send, Sync);
assert_impl_all!(LocalTraceLink: Send, Sync);
assert_impl_all!(RemoteTraceLink: Send, Sync);
assert_impl_all!(Replayability: Send, Sync);
assert_impl_all!(KernelProposal: Send, Sync);
assert_impl_all!(KernelIntent: Send, Sync);
assert_impl_all!(KernelContext: Send, Sync);
assert_impl_all!(ContextFact: Send, Sync);
assert_impl_all!(KernelPolicy: Send, Sync);
assert_impl_all!(ContractResult: Send, Sync);
assert_impl_all!(AdapterTrace: Send, Sync);
assert_impl_all!(SamplerParams: Send, Sync);
assert_impl_all!(RecallTrace: Send, Sync);
assert_impl_all!(ExecutionEnv: Send, Sync);

// =============================================================================
// ERROR TYPES
// =============================================================================

use converge_core::types::error::{
    TypeError, PromotionError, TypesValidationError, ObservationError, CorrectionError,
};

assert_impl_all!(TypeError: Send, Sync);
assert_impl_all!(PromotionError: Send, Sync);
assert_impl_all!(TypesValidationError: Send, Sync);
assert_impl_all!(ObservationError: Send, Sync);
assert_impl_all!(CorrectionError: Send, Sync);

// =============================================================================
// CAPABILITY TRAIT BOUND VERIFICATION
// =============================================================================
// Note: We can't directly assert traits are Send+Sync, but we document
// that implementations MUST be Send+Sync. The trait bounds enforce this:
//
// - Executor: Send + Sync required by trait definition
// - Randomness: Send + Sync required by trait definition
// - Fingerprint: Send + Sync required by trait definition
// - ChatBackend: Send + Sync + GAT constraints
// - EmbedBackend: Send + Sync + GAT constraints
// - RecallReader: Send + Sync required
// - RecallWriter: Send + Sync required
// - ExperienceAppender: Send + Sync required
// - ExperienceReplayer: Send + Sync required
// - Validator: Send + Sync required
// - Promoter: Send + Sync required
//
// The trait definitions in src/traits/*.rs include these bounds.
// If an implementation violates them, the compiler will reject it.
```

Note: If any type doesn't compile with these assertions, the implementation needs to be fixed (likely by making inner types Send+Sync or using Arc instead of Rc, etc.).
  </action>
  <verify>
```bash
cd /Users/kpernyer/repo/converge.zone/converge-platform/converge-core && cargo test traits::send_sync_static --no-run 2>&1 | tail -20
```
Compiles successfully (assertions are compile-time checks).
  </verify>
  <done>
- send_sync_static.rs contains assertions for all core types
- All types that cross thread boundaries are verified
- Capability trait bounds are documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Add trybuild dev-dependency and create test structure</name>
  <files>
    converge-platform/converge-core/Cargo.toml
    converge-platform/converge-core/tests/compile_fail/mod.rs
    converge-platform/converge-core/tests/compile_fail/compile_fail.rs
  </files>
  <action>
**Update Cargo.toml** - Add trybuild to dev-dependencies:

Read current Cargo.toml, add trybuild to [dev-dependencies]:
```toml
trybuild = "1.0"
```

**tests/compile_fail/mod.rs**: Empty module (trybuild uses its own test harness)

**tests/compile_fail/compile_fail.rs**: trybuild test runner

```rust
//! Compile-fail tests for private constructors.
//!
//! These tests verify that certain constructors are NOT accessible
//! from external code, enforcing the gate pattern invariants.

#[test]
fn compile_fail_tests() {
    let t = trybuild::TestCases::new();

    // Test that Fact::new() is private
    t.compile_fail("tests/compile_fail/ui/fact_new_private.rs");

    // Test that Proposal<Validated>::from_validated() is private
    t.compile_fail("tests/compile_fail/ui/validated_new_private.rs");

    // Test that ValidationReport::new() is private
    t.compile_fail("tests/compile_fail/ui/validation_report_private.rs");
}
```

Create the ui/ directory:
```bash
mkdir -p converge-platform/converge-core/tests/compile_fail/ui
```
  </action>
  <verify>
```bash
cd /Users/kpernyer/repo/converge.zone/converge-platform/converge-core && cargo check --tests 2>&1 | tail -20
```
Cargo.toml is valid, test structure exists.
  </verify>
  <done>
- trybuild added to dev-dependencies
- tests/compile_fail/compile_fail.rs exists with test runner
- ui/ directory created for test cases
  </done>
</task>

<task type="auto">
  <name>Task 3: Create compile-fail test cases</name>
  <files>
    converge-platform/converge-core/tests/compile_fail/ui/fact_new_private.rs
    converge-platform/converge-core/tests/compile_fail/ui/validated_new_private.rs
    converge-platform/converge-core/tests/compile_fail/ui/validation_report_private.rs
  </files>
  <action>
Per 06-RESEARCH.md, create test files that SHOULD NOT compile:

**ui/fact_new_private.rs**: Verify Fact::new() is inaccessible

```rust
//! This test verifies that Fact::new() cannot be called from external code.
//! It SHOULD fail to compile with a "private" error.

use converge_core::types::{Fact, FactId, FactContent, FactContentKind, PromotionRecord, Timestamp};

fn main() {
    // ERROR: Fact::new() is pub(crate), not pub
    // This demonstrates that Facts can only be created through PromotionGate
    let _fact = Fact::new(
        FactId::new("external-fact"),
        FactContent::new(FactContentKind::Claim, "I bypassed the gate!"),
        todo!(), // PromotionRecord - doesn't matter, won't compile
        Timestamp::now(),
    );
}
```

Create corresponding `.stderr` file (trybuild expects this for error matching):
**ui/fact_new_private.stderr**:
```
error[E0603]: function `new` is private
```
(trybuild will auto-generate the exact error on first run)

**ui/validated_new_private.rs**: Verify Proposal<Validated> constructor is inaccessible

```rust
//! This test verifies that Proposal<Validated> cannot be constructed externally.
//! It SHOULD fail to compile with a "private" error.

use converge_core::types::{
    Proposal, Validated, ProposalId, ProposedContent, ProposedContentKind,
    ObservationProvenance, ObservationId, Timestamp,
};

fn main() {
    // ERROR: from_validated() is pub(crate), not pub
    // This demonstrates that validated proposals can only come from validation
    let _validated: Proposal<Validated> = Proposal::from_validated(
        ProposalId::new("bypass-proposal"),
        ProposedContent::new(ProposedContentKind::Claim, "Skipping validation!"),
        ObservationProvenance::new(ObservationId::new("fake-obs"), Timestamp::now()),
    );
}
```

**ui/validation_report_private.rs**: Verify ValidationReport::new() is inaccessible

```rust
//! This test verifies that ValidationReport cannot be constructed externally.
//! It SHOULD fail to compile with a "private" error.

use converge_core::gates::{ValidationReport, CheckResult};
use converge_core::types::{ProposalId, ContentHash};

fn main() {
    // ERROR: ValidationReport::new() is pub(crate), not pub
    // This demonstrates that validation reports can only come from validators
    let _report = ValidationReport::new(
        ProposalId::new("fake-proposal"),
        vec![CheckResult::passed("fake_check")],
        ContentHash::zero(),
    );
}
```

**Important:** On first run, trybuild will create `.stderr` files with the actual error messages. These become the expected output for future runs. Run:
```bash
cd /Users/kpernyer/repo/converge.zone/converge-platform/converge-core && cargo test compile_fail -- --test-threads=1
```
to generate the `.stderr` files (or use `TRYBUILD=overwrite` env var).
  </action>
  <verify>
```bash
cd /Users/kpernyer/repo/converge.zone/converge-platform/converge-core && cargo test compile_fail 2>&1 | tail -30
```
Tests should fail initially (expected - .stderr files need generation), then pass after .stderr files are created.
  </verify>
  <done>
- ui/fact_new_private.rs tests Fact::new() is private
- ui/validated_new_private.rs tests Proposal<Validated> constructor is private
- ui/validation_report_private.rs tests ValidationReport::new() is private
- All tests designed to fail compilation (proving constructors are private)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
```bash
cd /Users/kpernyer/repo/converge.zone/converge-platform/converge-core && cargo test traits::send_sync_static compile_fail 2>&1 | tail -30
```
Static assertions compile. Compile-fail tests verify private constructors (may need to run with TRYBUILD=overwrite first to generate .stderr files).
</verification>

<success_criteria>
- [ ] tests/traits/send_sync_static.rs compiles (assertions pass)
- [ ] All core types verified Send+Sync
- [ ] trybuild added to Cargo.toml dev-dependencies
- [ ] tests/compile_fail/compile_fail.rs runs trybuild tests
- [ ] ui/fact_new_private.rs fails to compile (Fact::new is private)
- [ ] ui/validated_new_private.rs fails to compile (from_validated is private)
- [ ] ui/validation_report_private.rs fails to compile (ValidationReport::new is private)
- [ ] .stderr files generated/verified by trybuild
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-infrastructure/06-04-SUMMARY.md`
</output>
