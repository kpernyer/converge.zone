---
phase: 02-dependency-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - converge-platform/converge-core/src/engine.rs
  - converge-platform/converge-core/src/integrity.rs
  - converge-platform/converge-core/src/root_intent.rs
  - converge-platform/converge-core/Cargo.toml
  - converge-platform/converge-core/MIGRATION.md
autonomous: true

must_haves:
  truths:
    - "cargo deny check passes with zero violations"
    - "cargo build succeeds without forbidden dependencies"
    - "rayon, rand, sha2, hex are NOT in Cargo.toml dependencies"
    - "proptest, insta, static_assertions, serde_test, criterion are in dev-dependencies"
    - "MIGRATION.md documents breaking changes and migration path"
  artifacts:
    - path: "converge-platform/converge-core/Cargo.toml"
      provides: "Clean dependency list"
      contains: "[dev-dependencies]"
    - path: "converge-platform/converge-core/src/engine.rs"
      provides: "Sequential execution with deprecation"
      contains: "#[deprecated"
    - path: "converge-platform/converge-core/src/integrity.rs"
      provides: "Stub Fingerprint implementation"
      contains: "#[deprecated"
    - path: "converge-platform/converge-core/src/root_intent.rs"
      provides: "Timestamp-only ID generation"
      contains: "#[deprecated"
    - path: "converge-platform/converge-core/MIGRATION.md"
      provides: "Migration guide for v2.0.0"
      min_lines: 50
  key_links:
    - from: "converge-platform/converge-core/src/engine.rs"
      to: "converge-platform/converge-core/src/traits/mod.rs"
      via: "Executor trait reference in deprecation notice"
      pattern: "Executor"
    - from: "converge-platform/converge-core/src/integrity.rs"
      to: "converge-platform/converge-core/src/traits/mod.rs"
      via: "Fingerprint trait reference in deprecation notice"
      pattern: "Fingerprint"
---

<objective>
Remove all forbidden dependencies (rayon, rand, sha2, hex) from converge-core and add test infrastructure.

Purpose: Make cargo deny check pass. This is the phase that turns CI green after Phase 1 established the guardrails. Uses deprecation + trait abstraction pattern from CONTEXT.md.

Output: Clean Cargo.toml, refactored source files with deprecated sequential/stub implementations, MIGRATION.md documenting changes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dependency-cleanup/02-CONTEXT.md
@.planning/phases/02-dependency-cleanup/02-01-SUMMARY.md
@converge-platform/converge-core/src/engine.rs
@converge-platform/converge-core/src/integrity.rs
@converge-platform/converge-core/src/root_intent.rs
@converge-platform/converge-core/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace rayon in engine.rs with sequential execution</name>
  <files>converge-platform/converge-core/src/engine.rs</files>
  <action>
1. Remove the `use rayon::prelude::*;` import (line 15)

2. Find the `execute_agents` method (around line 412-425) that uses `par_iter()`:
```rust
fn execute_agents(&self, context: &Context, eligible: &[AgentId]) -> Vec<(AgentId, AgentEffect)> {
    eligible
        .par_iter()  // This uses rayon
        .map(|&id| { ... })
        .collect()
}
```

3. Replace with sequential iteration and add deprecation notice:
```rust
/// Executes agents sequentially and collects their effects.
///
/// # Deprecation Notice
///
/// This method currently uses sequential execution. In converge-core v2.0.0,
/// parallel execution was removed to eliminate the rayon dependency.
/// Use `converge-runtime` with an `Executor` implementation for parallel execution.
#[deprecated(since = "2.0.0", note = "Use converge-runtime with Executor trait for parallel execution")]
fn execute_agents(
    &self,
    context: &Context,
    eligible: &[AgentId],
) -> Vec<(AgentId, AgentEffect)> {
    eligible
        .iter()  // Sequential iteration
        .map(|&id| {
            let agent = &self.agents[id.0 as usize];
            let effect = agent.execute(context);
            (id, effect)
        })
        .collect()
}
```

4. Update the doc comment for `execute_agents` to reflect sequential execution (remove "parallel" from description).

5. Add `#[allow(deprecated)]` to the `run` method where `execute_agents` is called (around line 301-306) to suppress warning within the crate.
  </action>
  <verify>
```bash
cd converge-platform/converge-core && cargo check 2>&1 | grep -E "(error|rayon)" | head -10
```
No errors, no rayon references.
  </verify>
  <done>
- `use rayon::prelude::*;` removed
- `execute_agents` uses `.iter()` instead of `.par_iter()`
- Method marked `#[deprecated]` with migration note
- Deprecation warning suppressed in internal usage
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace sha2/hex in integrity.rs with stub implementation</name>
  <files>converge-platform/converge-core/src/integrity.rs</files>
  <action>
1. Remove imports (line 39):
```rust
use sha2::{Digest, Sha256};
```

2. For `ContentHash::compute()` (line 118-123), replace SHA-256 with a stub:
```rust
/// Computes a hash of the given content.
///
/// # Deprecation Notice
///
/// This method currently uses a stub implementation (FNV-1a hash padded to 32 bytes).
/// For cryptographic hashing, use `converge-runtime` with a `Fingerprint` implementation.
#[deprecated(since = "2.0.0", note = "Use converge-runtime with Fingerprint trait for cryptographic hashing")]
#[must_use]
pub fn compute(content: &str) -> Self {
    // Stub: FNV-1a hash (non-cryptographic, but deterministic)
    let mut hash = 0xcbf29ce484222325u64; // FNV offset basis
    for byte in content.as_bytes() {
        hash ^= u64::from(*byte);
        hash = hash.wrapping_mul(0x100000001b3); // FNV prime
    }
    // Pad to 32 bytes (repeat the 8-byte hash 4 times)
    let bytes = hash.to_le_bytes();
    let mut result = [0u8; 32];
    for i in 0..4 {
        result[i * 8..(i + 1) * 8].copy_from_slice(&bytes);
    }
    Self(result)
}
```

3. Update `compute_fact()` (line 127-134) similarly:
```rust
#[deprecated(since = "2.0.0", note = "Use converge-runtime with Fingerprint trait for cryptographic hashing")]
#[must_use]
pub fn compute_fact(fact: &Fact) -> Self {
    let combined = format!("{:?}|{}|{}", fact.key, fact.id, fact.content);
    #[allow(deprecated)]
    Self::compute(&combined)
}
```

4. Update `combine()` (line 138-144):
```rust
#[deprecated(since = "2.0.0", note = "Use converge-runtime with Fingerprint trait for cryptographic hashing")]
#[must_use]
pub fn combine(left: &Self, right: &Self) -> Self {
    // XOR the two hashes
    let mut result = [0u8; 32];
    for i in 0..32 {
        result[i] = left.0[i] ^ right.0[i];
    }
    Self(result)
}
```

5. Replace `to_hex()` (line 154-156) with manual implementation:
```rust
#[must_use]
pub fn to_hex(&self) -> String {
    self.0.iter().map(|b| format!("{b:02x}")).collect()
}
```

6. Replace `from_hex()` (line 163-169) with manual implementation:
```rust
/// Creates a `ContentHash` from a hex string.
///
/// # Errors
///
/// Returns an error if the string is not valid hex or wrong length.
pub fn from_hex(s: &str) -> Result<Self, ContentHashError> {
    if s.len() != 64 {
        return Err(ContentHashError::InvalidLength);
    }
    let mut result = [0u8; 32];
    for (i, chunk) in s.as_bytes().chunks(2).enumerate() {
        let high = Self::hex_char_to_nibble(chunk[0])?;
        let low = Self::hex_char_to_nibble(chunk[1])?;
        result[i] = (high << 4) | low;
    }
    Ok(Self(result))
}

fn hex_char_to_nibble(c: u8) -> Result<u8, ContentHashError> {
    match c {
        b'0'..=b'9' => Ok(c - b'0'),
        b'a'..=b'f' => Ok(c - b'a' + 10),
        b'A'..=b'F' => Ok(c - b'A' + 10),
        _ => Err(ContentHashError::InvalidHex),
    }
}
```

7. Add `ContentHashError` enum (before ContentHash impl):
```rust
/// Error type for ContentHash operations.
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum ContentHashError {
    /// Invalid hexadecimal character.
    InvalidHex,
    /// Invalid string length.
    InvalidLength,
}

impl std::fmt::Display for ContentHashError {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            Self::InvalidHex => write!(f, "invalid hexadecimal character"),
            Self::InvalidLength => write!(f, "invalid string length (expected 64 hex chars)"),
        }
    }
}

impl std::error::Error for ContentHashError {}
```

8. Update test `content_hash_hex_roundtrip` to use the new error type.

9. Add `#[allow(deprecated)]` to internal usages (MerkleRoot, TrackedContext methods).
  </action>
  <verify>
```bash
cd converge-platform/converge-core && cargo check 2>&1 | grep -E "(error|sha2|hex::)" | head -10
```
No errors, no sha2/hex references.
  </verify>
  <done>
- `use sha2::{Digest, Sha256};` removed
- ContentHash uses stub FNV-1a implementation
- to_hex/from_hex use manual implementations
- ContentHashError replaces hex::FromHexError
- Methods marked `#[deprecated]` with migration notes
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace rand in root_intent.rs and update Cargo.toml</name>
  <files>
converge-platform/converge-core/src/root_intent.rs
converge-platform/converge-core/Cargo.toml
  </files>
  <action>
**In root_intent.rs:**

1. Find `IntentId::generate()` (line 61-69) which uses `rand::random()`:
```rust
pub fn generate() -> Self {
    use std::time::{SystemTime, UNIX_EPOCH};
    let timestamp = SystemTime::now()
        .duration_since(UNIX_EPOCH)
        .unwrap_or_default()
        .as_nanos();
    let random: u32 = rand::random();  // Uses rand
    Self(format!("intent-{timestamp:x}-{random:08x}"))
}
```

2. Replace with timestamp-only + process ID (no rand):
```rust
/// Generates a new unique intent ID.
///
/// # Deprecation Notice
///
/// This method uses timestamp + process ID for uniqueness. For cryptographically
/// random IDs, use `converge-runtime` with a `Randomness` implementation.
#[deprecated(since = "2.0.0", note = "Use converge-runtime with Randomness trait for random ID generation")]
#[must_use]
pub fn generate() -> Self {
    use std::time::{SystemTime, UNIX_EPOCH};
    let timestamp = SystemTime::now()
        .duration_since(UNIX_EPOCH)
        .unwrap_or_default()
        .as_nanos();
    // Use process ID and a counter for uniqueness without rand
    static COUNTER: std::sync::atomic::AtomicU32 = std::sync::atomic::AtomicU32::new(0);
    let counter = COUNTER.fetch_add(1, std::sync::atomic::Ordering::Relaxed);
    let pid = std::process::id();
    Self(format!("intent-{timestamp:x}-{pid:08x}-{counter:04x}"))
}
```

3. Add `#[allow(deprecated)]` to `RootIntent::new()` where `IntentId::generate()` is called.

**In Cargo.toml:**

4. Remove forbidden dependencies from `[dependencies]`:
```toml
# REMOVE these lines:
rayon = "1.10"
rand = "0.8"
sha2 = "0.10"
hex = "0.4"
```

5. Add new dev-dependencies:
```toml
[dev-dependencies]
tracing-test = "0.2"
proptest = "1.4"
insta = "1.42"
static_assertions = "1.1"
serde_test = "1.0"
criterion = { version = "0.5", features = ["html_reports"] }
```

6. Add criterion benchmark configuration:
```toml
[[bench]]
name = "engine_bench"
harness = false
```
  </action>
  <verify>
```bash
cd converge-platform/converge-core && cargo check 2>&1 | grep -E "(error|rand::)" | head -10
```
No errors, no rand references.

```bash
cd converge-platform/converge-core && cargo deny check bans 2>&1 | tail -5
```
Should show "bans ok" or no violations.
  </verify>
  <done>
- `rand::random()` replaced with timestamp + pid + counter
- IntentId::generate() marked `#[deprecated]`
- Cargo.toml: rayon, rand, sha2, hex REMOVED from dependencies
- Cargo.toml: insta, static_assertions, serde_test, criterion ADDED to dev-dependencies
- `cargo deny check` passes
  </done>
</task>

<task type="auto">
  <name>Task 4: Create MIGRATION.md documenting breaking changes</name>
  <files>converge-platform/converge-core/MIGRATION.md</files>
  <action>
Create MIGRATION.md with the following content:

```markdown
# Migration Guide: converge-core v2.0.0

This document describes breaking changes in converge-core v2.0.0 and how to migrate.

## Overview

converge-core v2.0.0 removes all runtime dependencies (rayon, rand, sha2, hex) to achieve
a pure, portable core. Functionality that required these dependencies is now provided
through capability traits that external crates implement.

## Breaking Changes

### 1. Parallel Execution Removed

**What changed:** `Engine::execute_agents` no longer uses Rayon for parallel execution.

**Why:** Rayon is a runtime dependency that violates converge-core's purity principles.
The core library should be portable across all environments including WASM.

**Migration:**

Before (v1.x):
- Agents executed in parallel automatically via Rayon

After (v2.0.0):
- Agents execute sequentially by default
- For parallel execution, use `converge-runtime` with an `Executor` implementation

```rust
// v2.0.0: Use converge-runtime for parallel execution
use converge_runtime::ParallelExecutor;

let executor = ParallelExecutor::new();
let engine = Engine::with_executor(executor);  // Future API
```

### 2. Cryptographic Hashing Changed

**What changed:** `ContentHash::compute` no longer uses SHA-256.

**Why:** sha2 is a runtime dependency. Cryptographic hashing should be configurable.

**Migration:**

Before (v1.x):
- `ContentHash::compute("data")` returned SHA-256 hash

After (v2.0.0):
- `ContentHash::compute("data")` returns a non-cryptographic hash (FNV-1a)
- For cryptographic hashing, use `converge-runtime` with a `Fingerprint` implementation

```rust
// v2.0.0: Use converge-runtime for SHA-256
use converge_runtime::{Sha256Fingerprint, Fingerprint};

let fingerprint = Sha256Fingerprint::new();
let hash = fingerprint.compute(data.as_bytes());
```

### 3. Random ID Generation Changed

**What changed:** `IntentId::generate()` no longer uses cryptographic randomness.

**Why:** rand is a runtime dependency that may not be available in all environments.

**Migration:**

Before (v1.x):
- `IntentId::generate()` used `rand::random()` for uniqueness

After (v2.0.0):
- `IntentId::generate()` uses timestamp + process ID + counter
- For cryptographic randomness, use `converge-runtime` with a `Randomness` implementation

```rust
// v2.0.0: Use converge-runtime for random IDs
use converge_runtime::{SystemRandomness, Randomness};

let rng = SystemRandomness::new();
let random_bytes = rng.random_u32();
let id = IntentId::new(format!("intent-{random_bytes:08x}"));
```

### 4. Hex Encoding API Changed

**What changed:** `ContentHash::from_hex` returns `ContentHashError` instead of `hex::FromHexError`.

**Migration:**

```rust
// Before (v1.x)
let hash = ContentHash::from_hex(s)?;  // Returns hex::FromHexError

// After (v2.0.0)
let hash = ContentHash::from_hex(s)?;  // Returns ContentHashError
```

## Capability Traits

converge-core v2.0.0 introduces capability boundary traits in `converge_core::traits`:

| Trait | Replaces | Purpose |
|-------|----------|---------|
| `Executor` | rayon | Parallel execution |
| `Fingerprint` | sha2/hex | Cryptographic hashing |
| `Randomness` | rand | Random number generation |

These traits are defined in converge-core but implemented in converge-runtime.

## Deprecation Warnings

Methods using the legacy stub implementations are marked `#[deprecated]`:

- `Engine::execute_agents` - Use Executor trait
- `ContentHash::compute` - Use Fingerprint trait
- `ContentHash::compute_fact` - Use Fingerprint trait
- `ContentHash::combine` - Use Fingerprint trait
- `IntentId::generate` - Use Randomness trait

To suppress warnings while migrating:

```rust
#[allow(deprecated)]
let id = IntentId::generate();
```

## Timeline

- **v2.0.0**: Deprecated methods available, stub implementations work
- **v3.0.0** (future): Deprecated methods removed, trait implementations required

## Getting Help

- See `PURITY.md` for the full list of allowed/forbidden dependencies
- See `BOUNDARY.md` (Phase 5) for trait ownership documentation
- File issues at https://github.com/kpernyer/converge-core/issues
```
  </action>
  <verify>
```bash
test -f converge-platform/converge-core/MIGRATION.md && wc -l converge-platform/converge-core/MIGRATION.md
```
File exists and has substantial content (>50 lines).
  </verify>
  <done>
- MIGRATION.md exists in converge-core directory
- Documents all 4 breaking changes
- Provides before/after code examples
- Explains capability traits and migration path
- Mentions deprecation timeline
  </done>
</task>

</tasks>

<verification>
```bash
# Primary success criteria: cargo deny passes
cd converge-platform/converge-core && cargo deny check bans
```
Expected: "bans ok" with zero violations

```bash
# Build succeeds
cd converge-platform/converge-core && cargo build
```
Expected: Compilation succeeds (deprecation warnings OK)

```bash
# Tests pass
cd converge-platform/converge-core && cargo test
```
Expected: All tests pass

```bash
# Forbidden deps not in Cargo.toml
grep -E "^(rayon|rand|sha2|hex) =" converge-platform/converge-core/Cargo.toml
```
Expected: No output (deps removed)

```bash
# Dev deps present
grep -E "^(insta|static_assertions|serde_test|criterion)" converge-platform/converge-core/Cargo.toml
```
Expected: All four found
</verification>

<success_criteria>
1. `cargo deny check bans` passes with zero violations
2. `cargo build` succeeds (deprecation warnings acceptable)
3. `cargo test` passes (all existing tests work with stub implementations)
4. rayon, rand, sha2, hex NOT in [dependencies]
5. insta, static_assertions, serde_test, criterion in [dev-dependencies]
6. MIGRATION.md exists with >50 lines documenting all changes
7. Deprecated methods have `#[deprecated]` attribute with migration notes
</success_criteria>

<output>
After completion, create `.planning/phases/02-dependency-cleanup/02-02-SUMMARY.md`
</output>
