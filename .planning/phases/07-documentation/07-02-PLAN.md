---
phase: 07-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - converge-platform/converge-core/.github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "cargo-semver-checks runs in CI on converge-core"
    - "Breaking API changes are detected and reported"
    - "CI workflow exists for converge-core specifically"
  artifacts:
    - path: "converge-platform/converge-core/.github/workflows/ci.yml"
      provides: "CI workflow with semver checks"
      contains: "cargo-semver-checks"
  key_links:
    - from: "CI workflow"
      to: "cargo-semver-checks-action"
      via: "GitHub Action"
      pattern: "obi1kenobi/cargo-semver-checks-action"
---

<objective>
Add cargo-semver-checks to converge-core CI for automated API stability verification.

Purpose: Fulfill REQ-CI-06 (API stability checks). Detect breaking changes to the public API automatically before they're merged.

Output: CI workflow that runs cargo-semver-checks on every PR and push to main, catching unintentional breaking changes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-documentation/07-RESEARCH.md

# Existing CI (workspace level, for reference)
@converge-platform/.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create converge-core CI workflow</name>
  <files>converge-platform/converge-core/.github/workflows/ci.yml</files>
  <action>
Create a dedicated CI workflow for converge-core at `converge-platform/converge-core/.github/workflows/ci.yml`.

First, create the directory if it doesn't exist:
```bash
mkdir -p converge-platform/converge-core/.github/workflows
```

Then create the workflow file with:

```yaml
name: converge-core CI

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'deny.toml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'deny.toml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check:
    name: Check & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build

      - name: Test
        run: cargo test

      - name: Doc tests
        run: cargo test --doc

  deny:
    name: Dependency Policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check dependency policy
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check bans licenses sources

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build docs
        run: cargo doc --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  semver:
    name: API Stability
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check semver
        uses: obi1kenobi/cargo-semver-checks-action@v2
        with:
          # Use git baseline since this may not be published to crates.io
          # Compare against the last commit on main
          baseline-rev: ${{ github.event_name == 'pull_request' && github.base_ref || 'HEAD~1' }}
```

This workflow:
1. Runs on pushes/PRs to main, filtered to relevant paths
2. check job: fmt, clippy, build, test, doc tests
3. deny job: cargo-deny for purity enforcement
4. docs job: cargo doc with warnings as errors
5. semver job: cargo-semver-checks against git baseline
  </action>
  <verify>
Verify workflow file syntax:
```bash
cd converge-platform/converge-core
cat .github/workflows/ci.yml | head -50
```
Check YAML structure is valid (proper indentation, no syntax errors).
  </verify>
  <done>CI workflow file exists at converge-platform/converge-core/.github/workflows/ci.yml with all required jobs.</done>
</task>

<task type="auto">
  <name>Task 2: Verify cargo-semver-checks configuration</name>
  <files>converge-platform/converge-core/.github/workflows/ci.yml</files>
  <action>
Verify the cargo-semver-checks configuration is correct:

1. Check that `fetch-depth: 0` is set on checkout (needed for git history)
2. Check that baseline-rev handles both PR and push cases:
   - PR: Compare against base branch (main)
   - Push: Compare against HEAD~1

The baseline-rev expression should be:
```yaml
baseline-rev: ${{ github.event_name == 'pull_request' && github.base_ref || 'HEAD~1' }}
```

If converge-core is published to crates.io and you want to compare against the published version instead:
```yaml
baseline-version: 0.6.2  # Update when releasing
```

For this project (private crate), git-based comparison is more appropriate.

Test the workflow locally (optional, for verification):
```bash
cd converge-platform/converge-core
cargo install cargo-semver-checks
cargo semver-checks check-release --baseline-rev HEAD~1
```

Note: This may show some changes if recent commits added new public items - that's expected.
  </action>
  <verify>
Run locally to test:
```bash
cd converge-platform/converge-core && cargo semver-checks check-release --baseline-rev HEAD~1 2>&1 | head -20
```
If cargo-semver-checks isn't installed, verify workflow syntax instead:
```bash
grep -A 10 "semver:" converge-platform/converge-core/.github/workflows/ci.yml
```
  </verify>
  <done>cargo-semver-checks is configured correctly with git-based baseline comparison.</done>
</task>

</tasks>

<verification>
1. `ls converge-platform/converge-core/.github/workflows/ci.yml` - file exists
2. `grep "cargo-semver-checks" converge-platform/converge-core/.github/workflows/ci.yml` - action is present
3. `grep "fetch-depth: 0" converge-platform/converge-core/.github/workflows/ci.yml` - git history available
4. YAML syntax valid (no errors when parsed)
</verification>

<success_criteria>
- converge-core has its own CI workflow at .github/workflows/ci.yml
- Workflow includes cargo-semver-checks job for API stability
- Workflow includes cargo-deny job for purity enforcement
- Workflow includes doc build with RUSTDOCFLAGS=-D warnings
- Baseline comparison uses git-based approach (not crates.io version)
</success_criteria>

<output>
After completion, create `.planning/phases/07-documentation/07-02-SUMMARY.md`
</output>
